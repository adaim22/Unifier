<style>
    #chatPeerInfo {
        background: red;
    }

    #chatInfo {
        background: green;
    }

    #chatHistory {
        background: blue;
        list-style: none;
    }

    #chatHistory > .msg {
    }

    #chatHistory > .msg-local {
        background: pink;
    }

    #chatHistory > .msg-remote {
        background: purple;
    }

    #chatHistory > .date-separator {
        display: flex;
        align-items: center;
        text-align: center;
    }

    #chatHistory > .date-separator::before, #chatHistory > .date-separator::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid #000;
    }

    #chatHistory > .date-separator:not(:empty)::before {
        margin-right: .25em;
    }

    #chatHistory > .date-separator:not(:empty)::after {
        margin-left: .25em;
    }

    #chatExit {
        background: brown;
    }

    #chatMsgInput {
        background: yellow;
    }

    #chatMsgSubmit {
        background: orange;
    }
</style>
<div class="container-fluid d-flex flex-column" style="height: 100%;">
    <div class="row flex-shrink-1" id="chatHeader">
        <div class="col" id="chatPeerInfo">
            Talking with John Doe
        </div>
        <div class="col" id="chatInfo">
            Last Sent Message: xx/yy/zzzz | Other Info
        </div>
    </div>
    <div class="row flex-grow-1 flex-shrink-1" id="chatBody">
        <ul class="col" id="chatHistory">
            <li class="msg msg-local">History</li>
            <li class="msg msg-local">History 2</li>
            <div class="date-separator">New Date</div>
            <li class="msg msg-remote">Remote Message</li>
        </ul>
        <template id="chatDateSeparatorTemplate">
            <div class="date-separator"></div>
        </template>
        <template id="chatMsgTemplate">
            <li>
                <span></span> | <span></span>
            </li>
        </template>
    </div>
    <div class="row flex-shrink-1" id="chatFooter">
        <button class="col-2" id="chatExit">
            Leave
        </button>
        <textarea class="col-8" id="chatMsgInput" placeholder="Enter a message...">
        </textarea>
        <button class="col-2" id="chatMsgSubmit">
            Send
        </button>
    </div>
</div>
<script>
    const months = [
        'January',
        'February',
        'March',
        'April',
        'May',
        'June',
        'July',
        'August',
        'September',
        'October',
        'November',
        'December'
    ];

    function getMonthIndex(month) {
        for (let idx in months) {
            if (months[idx] === month) return idx;
        }

        return -1;
    }

    function datestampIndex(datestamp) {
        if (datestamp === null) {
            return -1;
        }

        const [day, month, year] = datestamp.split(' ');

        return parseInt(`${year}${getMonthIndex(month)}${day}`);
    }

    let lastMessageIndex = datestampIndex(null);

    function formatTimestamp(date) {
        if (date === null) {
            return ['', ''];
        }

        const second = date.getSeconds(), minute = date.getMinutes(), hour = date.getHours();
        const day = date.getDate(), month = date.getMonth(), year = date.getFullYear();

        return [
            `${new String(hour).padStart(2, '0')}:${new String(minute).padStart(2, '0')}`,
            `${new String(day).padStart(2, '0')} ${months[month]} ${year}`
        ];
    }

    const chatHistory = document.getElementById('chatHistory');
    const chatDateSeparatorTemplate = document.getElementById('chatDateSeparatorTemplate');
    const chatMessageTemplate = document.getElementById('chatMsgTemplate');

    function createChatMessage(timestamp, datestamp, content, isLocal) {
        const message = chatMessageTemplate.content.firstElementChild.cloneNode(true);

        message.className += 'msg ';
        message.className += isLocal ? 'msg-local ' : 'msg-remote ';
        
        const templateSegments = message.querySelectorAll('span');
        const messageTimestamp = templateSegments[0];
        messageTimestamp.textContent = timestamp;

        const messageContent = templateSegments[1];
        messageContent.textContent = content;

        const messageDateIndex = datestampIndex(datestamp);

        if (lastMessageIndex < messageDateIndex) {
            lastMessageIndex = messageDateIndex;

            const dateSeparator = chatDateSeparatorTemplate.content.firstElementChild.cloneNode(true);

            dateSeparator.textContent = datestamp;

            chatHistory.appendChild(dateSeparator);
        }

        chatHistory.appendChild(message);
    }

    const quitButton = document.getElementById('chatExit');
    quitButton.addEventListener('click', function(e) {
        function onSuccess(xhr, xhrResponse, xhrResponseType) {
            window.location.replace('/index.html')
        }

        function onFailure(xhr, xhrResponse) {
        }

        const headers = [];
        const body = null;

        REST('/api/stopConversation', 'POST', true, 0, headers, body, onSuccess, onFailure);
    });

    const messageSource = document.getElementById('chatMsgInput');

    const sendButton = document.getElementById('chatMsgSubmit');
    sendButton.addEventListener('click', function(e) {
        const date = new Date();
        const [timestamp, datestamp] = formatTimestamp(date);
        createChatMessage(timestamp, datestamp, messageSource.value, true);
        messageSource.value = '';
        
        function onSuccess(xhr, xhrResponse, xhrResponseType) {
        }

        function onFailure(xhr, xhrStatus) {
        }

        const headers = [];
        const body = null;

        REST('/api/sendMessage', 'POST', true, 0, headers, body, onSuccess, onFailure);
    });

    setInterval(function() {
        const date = new Date();

        function onSuccess(xhr, xhrResponse, xhrResponseType) {
            const response = JSON.parse(xhrResponse);
            
            for (let message of response) {
                createChatMessage(message['timestamp'], message['datestamp'], message['content'], message['isLocal'])
            }
        }

        function onFailure(xhr, xhrResponse) {
        }

        const headers = [['Content-Type', 'multipart/form-data']];
        const body = new FormData();
        body.set('fromDate', date);

        REST('/api/fetchMessages', 'GET', true, 0, headers, body, onSuccess, onFailure);
    }, 2500);
</script>
